{"version":3,"sources":["alchemy.js"],"names":["window","document","AO","on","tinymce","initialSettings","tinyMCEPreInit","mceInit","$","$userProfileContainer","$metaboxes","$alchemy","pageID","$alchOptions","searchParams","popperInstances","URL","location","href","get","$fields","constrFields","$field","field","children","wp","$children","i","child","type","find","each","push","$button","Function","alchemy","this","map","destroy","data","attr","removeClass","text","concat","id","instance","next","ajax","saveOptionsData","AlchemyData","dataType","all","fieldsPromises","then","values","success","append","nonce","reload","JSON","stringify","error","responseJSON","messsages","topMostPosition","url","contentType","$tooltip","blockTop","offset","code","Popper","modifiers","fallbackPlacements","top","parents","addClass","createPopper","placement","name","options","one","hasClass","removeAttr","add","animate","scrollTop","$postForm","subscribe","editor","select","$postBox","closest","saved","save_metadata","remove","e","$profileForm","preventDefault","isSavingPost","click","userProfileData","userID","processData","submit","method","saveMetaboxesData","Promise","postID","jQuery"],"mappings":"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","file":"alchemy.min.js","sourcesContent":["'use strict';\r\n\r\n((window, document, $) => {\r\n    window.AO = window.AO || {};\r\n\r\n    $(document).on('tinymce-editor-init', () => {\r\n        AO.tinymce = AO.tinymce || {};\r\n        AO.tinymce.initialSettings = tinyMCEPreInit.mceInit['alchemy-temp-editor'];\r\n    });\r\n\r\n    $(() => {\r\n        const $alchemy = $('.jsAlchemy');\r\n        const $metaboxes = $('.jsAlchemyMetaBox');\r\n        const $userProfileContainer = $('.jsAlchemyUserProfile');\r\n\r\n        if( ! $alchemy ) {\r\n            return;\r\n        }\r\n\r\n        const $alchOptions = $('.jsAlchemyOptions');\r\n        const currentUrl = new URL(window.location.href);\r\n        const pageID = currentUrl.searchParams.get('page');\r\n        const data = new FormData();\r\n        const popperInstances = {};\r\n\r\n        const $fields = $alchOptions.children('.jsAlchemyField');\r\n        const constrFields = [];\r\n\r\n        $fields.each((i, field) => {\r\n            const $field = $(field);\r\n\r\n            if( 'sections' === $field.data('alchemy').type ) {\r\n                const $children = $field.find('.jsAlchemySectionsTab').children('.jsAlchemyField');\r\n\r\n                if( $children[0] ) {\r\n                    $children.each((i, child) => {\r\n                        constrFields.push($(child));\r\n                    });\r\n                }\r\n            } else {\r\n                constrFields.push($field);\r\n            }\r\n        });\r\n\r\n        $alchemy.on('click', '.jsAlchemySaveOptions', function() {\r\n            const $button = $(this);\r\n            const fieldsPromises = $(constrFields).map((i, $field) => {\r\n                const alchemy = $field.data('alchemy');\r\n\r\n                $field.removeClass('alchemy__field--invalid').children('.jsAlchemyValidationTooltip').find('.jsAlchemyTooltipText').text('');\r\n\r\n                return new Function( `return AO['get_${alchemy.type}_value']('${alchemy.id}');` )(alchemy.id)\r\n            }).get();\r\n\r\n            $.each(popperInstances, (i, instance) => {\r\n                instance.destroy();\r\n            });\r\n\r\n            $button.attr('disabled', true).next('.jsAlchemyLoader').removeClass('alchemy__spinner--hidden');\r\n\r\n            let saveOptionsData = AlchemyData['save-options'];\r\n\r\n            if( $button.data() && 'network' === $button.data('type') ) {\r\n                saveOptionsData = AlchemyData['save-network-options'];\r\n            }\r\n\r\n            Promise.all(fieldsPromises).then(values => {\r\n                data.append('_wpnonce', saveOptionsData.nonce);\r\n                data.append('page-id', pageID);\r\n                data.append('values', JSON.stringify(values));\r\n\r\n                $.ajax({\r\n                    method: \"POST\",\r\n                    url: saveOptionsData.url,\r\n                    dataType: 'json',\r\n                    processData: false,\r\n                    contentType: false,\r\n                    data: data,\r\n                    success: () => {\r\n                        window.location.reload();\r\n                    },\r\n                    error: error => {\r\n                        if( error.responseJSON.data && 'alch-save-validation-errors' === error.responseJSON.code ) {\r\n                            const messsages = error.responseJSON.data['invalid-fields'];\r\n\r\n                            let topMostPosition = 0;\r\n\r\n                            $(constrFields).each((i, $field) => {\r\n                                const alchemy = $field.data('alchemy');\r\n\r\n                                if( messsages[alchemy.id] ) {\r\n                                    const $tooltip = $field.children('.jsAlchemyValidationTooltip');\r\n                                    const blockTop = $field.offset().top;\r\n\r\n                                    topMostPosition = -100 + ( blockTop > topMostPosition ? blockTop : topMostPosition );\r\n\r\n                                    if( $tooltip[0] ) {\r\n                                        $tooltip.attr('data-show', true).find('.jsAlchemyTooltipText').text(messsages[alchemy.id]);\r\n\r\n                                        $field.addClass('alchemy__field--invalid').parents('.repeatee').addClass('repeatee--expanded');\r\n\r\n                                        popperInstances[alchemy.id] = Popper.createPopper( $field[0], $tooltip[0], {\r\n                                            placement: 'top',\r\n                                            modifiers: [\r\n                                                {\r\n                                                    name: 'flip',\r\n                                                    options: {\r\n                                                        fallbackPlacements: ['top-start'],\r\n                                                    },\r\n                                                }\r\n                                            ],\r\n                                        } );\r\n\r\n                                        $field.one('hover focus', () => {\r\n                                            if( $field.hasClass('alchemy__field--invalid') ) {\r\n                                                $field.removeClass('alchemy__field--invalid');\r\n\r\n                                                if( popperInstances[alchemy.id] ) {\r\n                                                    popperInstances[alchemy.id].destroy();\r\n\r\n                                                    $tooltip.removeAttr('data-show');\r\n                                                }\r\n                                            }\r\n                                        });\r\n\r\n                                        if( topMostPosition ) {\r\n                                            $('html').add('body').animate({ scrollTop: topMostPosition }, 500);\r\n                                        }\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n\r\n                        $button.next('.jsAlchemyLoader').addClass('alchemy__spinner--hidden');\r\n                    },\r\n                    complete: () => {\r\n                        $button.removeAttr('disabled');\r\n                    }\r\n                });\r\n            });\r\n        });\r\n\r\n        if( $metaboxes[0] ) {\r\n            const $postForm = $('#post');\r\n            const $postBox = $metaboxes.closest('.postbox');\r\n\r\n            $postBox.find('.hndle').removeClass('hndle'); // this removes dnd for metaboxes\r\n\r\n            // this removes metaboxes sorting buttons (WP 5.5). It is needed not to break WYSIWYGs\r\n            $postBox.find('.handle-order-higher').remove();\r\n            $postBox.find('.handle-order-lower').remove();\r\n\r\n            if( $postForm[0] ) {\r\n                $('#publish').on('click', function(e) {\r\n                    $(this).attr('disabled', true);\r\n\r\n                    save_metadata($postForm);\r\n\r\n                    e.preventDefault();\r\n                });\r\n            } else if( wp.data && wp.data.subscribe ) {\r\n                let saved = true; // helps against multiple save calls\r\n\r\n                wp.data.subscribe(() => {\r\n                    const editor = wp.data.select('core/editor');\r\n\r\n                    if ( editor.isSavingPost() ) {\r\n                        saved = false;\r\n                    } else {\r\n                        if ( ! saved ) {\r\n                            save_metadata();\r\n\r\n                            saved = true;\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n\r\n        if( $userProfileContainer[0] ) {\r\n            const $profileForm = $('#your-profile');\r\n\r\n            let saved = false;\r\n\r\n            if( $profileForm[0] ) {\r\n                $profileForm.on('submit', e => {\r\n                    if( ! saved ) {\r\n                        const $fields = $userProfileContainer.children('.jsAlchemyField');\r\n                        const constrFields = [];\r\n\r\n                        $profileForm.find('[type=\"submit\"]').attr('disabled', true)\r\n\r\n                        $fields.each((i, field) => {\r\n                            const $field = $(field);\r\n\r\n                            if( 'sections' === $field.data('alchemy').type ) {\r\n                                const $children = $field.find('.jsAlchemySectionsTab').children('.jsAlchemyField');\r\n\r\n                                if( $children[0] ) {\r\n                                    $children.each((i, child) => {\r\n                                        constrFields.push($(child));\r\n                                    });\r\n                                }\r\n                            } else {\r\n                                constrFields.push($field);\r\n                            }\r\n                        });\r\n\r\n                        const fieldsPromises = $(constrFields).map((i, field) => {\r\n                            const alchemy = $(field).data('alchemy');\r\n\r\n                            return new Function( `return AO['get_${alchemy.type}_value']('${alchemy.id}');` )(alchemy.id)\r\n                        }).get();\r\n\r\n                        const userProfileData = AlchemyData['save-user-profile'];\r\n\r\n                        Promise.all(fieldsPromises).then(values => {\r\n                            data.append('_wpnonce', userProfileData.nonce);\r\n                            data.append('user-id', userProfileData.userID);\r\n                            data.append('values', JSON.stringify(values));\r\n\r\n                            $.ajax({\r\n                                method: \"POST\",\r\n                                url: userProfileData.url,\r\n                                dataType: 'json',\r\n                                processData: false,\r\n                                contentType: false,\r\n                                data: data,\r\n                                success: () => {\r\n                                    $profileForm.submit();\r\n                                }\r\n                            });\r\n                        });\r\n\r\n                        e.preventDefault();\r\n                    } else {\r\n                        $profileForm.find('[type=\"submit\"]').removeAttr('disabled').addClass('disabled').click();\r\n                    }\r\n\r\n                    saved = true;\r\n                });\r\n            }\r\n        }\r\n\r\n        function save_metadata($postForm) {\r\n            const $fields = $metaboxes.children('.metabox__fields').children('.jsAlchemyField');\r\n            const constrFields = [];\r\n\r\n            $fields.each((i, field) => {\r\n                const $field = $(field);\r\n\r\n                if( 'sections' === $field.data('alchemy').type ) {\r\n                    const $children = $field.find('.jsAlchemySectionsTab').children('.jsAlchemyField');\r\n\r\n                    if( $children[0] ) {\r\n                        $children.each((i, child) => {\r\n                            constrFields.push($(child));\r\n                        });\r\n                    }\r\n                } else {\r\n                    constrFields.push($field);\r\n                }\r\n            });\r\n\r\n            const fieldsPromises = $(constrFields).map((i, field) => {\r\n                const alchemy = $(field).data('alchemy');\r\n\r\n                return new Function( `return AO['get_${alchemy.type}_value']('${alchemy.id}');` )(alchemy.id)\r\n            }).get();\r\n\r\n            const saveMetaboxesData = AlchemyData['save-metaboxes'];\r\n\r\n            Promise.all(fieldsPromises).then(values => {\r\n                data.append('_wpnonce', saveMetaboxesData.nonce);\r\n                data.append('post-id', saveMetaboxesData.postID);\r\n                data.append('values', JSON.stringify(values));\r\n\r\n                $.ajax({\r\n                    method: \"POST\",\r\n                    url: saveMetaboxesData.url,\r\n                    dataType: 'json',\r\n                    processData: false,\r\n                    contentType: false,\r\n                    data: data,\r\n                    success: () => {\r\n                        if( $postForm && $postForm[0] ) {\r\n                            $postForm.submit();\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    });\r\n})(window, document, jQuery);\r\n"]}